# æ‰¹é‡æ’å…¥å¿«é€Ÿå‚è€ƒæŒ‡å—

## ğŸ¯ ä¸€å¥è¯æ€»ç»“

**æ¨èé»˜è®¤æ‰¹æ¬¡å¤§å°ï¼š200**ï¼ˆé€‚ç”¨äº 90% çš„åœºæ™¯ï¼‰

## ğŸ“Š å¿«é€Ÿå†³ç­–è¡¨

```
æˆå‘˜æ•°é‡          æ¨èæ‰¹æ¬¡å¤§å°      é¢„æœŸè€—æ—¶        å†…å­˜å ç”¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
< 100 äºº          100             < 100ms        < 1MB
100-500 äºº        100-200         < 300ms        < 2MB
500-2000 äºº       200-300         < 1s           < 3MB
2000-5000 äºº      500             < 3s           < 5MB
> 5000 äºº         500 + å¼‚æ­¥      åˆ†æ‰¹å¤„ç†        < 10MB
```

## ğŸš€ ä»£ç ç¤ºä¾‹

### æ–¹æ¡ˆ1ï¼šå›ºå®šæ‰¹æ¬¡ï¼ˆæ¨èï¼‰

```go
// é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯
tx.CreateInBatches(members, 200)
```

### æ–¹æ¡ˆ2ï¼šåŠ¨æ€æ‰¹æ¬¡

```go
func getBatchSize(count int) int {
    switch {
    case count <= 100:   return 100
    case count <= 500:   return 100
    case count <= 2000:  return 200
    case count <= 5000:  return 500
    default:             return 500
    }
}

batchSize := getBatchSize(len(members))
tx.CreateInBatches(members, batchSize)
```

### æ–¹æ¡ˆ3ï¼šè¶…å¤§ç¾¤å¼‚æ­¥å¤„ç†

```go
func CreateLargeGroup(members []*ChannelMember) error {
    // 1. å…ˆæ’å…¥å‰ 100 ä¸ªæˆå‘˜
    initial := members[:100]
    tx.CreateInBatches(initial, 100)
    
    // 2. å¼‚æ­¥æ’å…¥å‰©ä½™æˆå‘˜
    go func() {
        remaining := members[100:]
        for i := 0; i < len(remaining); i += 500 {
            end := min(i+500, len(remaining))
            batch := remaining[i:end]
            tx.CreateInBatches(batch, 500)
            time.Sleep(10 * time.Millisecond)
        }
    }()
    
    return nil
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### âœ… åº”è¯¥åšçš„

- âœ… ä½¿ç”¨æ‰¹æ¬¡å¤§å° 100-500
- âœ… é¢„åˆ†é…åˆ‡ç‰‡å®¹é‡ï¼š`make([]*T, 0, capacity)`
- âœ… ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯åŸå­æ€§
- âœ… ç›‘æ§æ…¢æŸ¥è¯¢ï¼ˆ> 200msï¼‰
- âœ… é…ç½®åˆç†çš„è¿æ¥æ± 

### âŒ ä¸åº”è¯¥åšçš„

- âŒ æ‰¹æ¬¡ < 50ï¼ˆç½‘ç»œå¼€é”€å¤§ï¼‰
- âŒ æ‰¹æ¬¡ > 1000ï¼ˆå†…å­˜å ç”¨é«˜ï¼‰
- âŒ é€æ¡æ’å…¥ï¼ˆæ€§èƒ½å·® 20 å€ï¼‰
- âŒ ä¸ä½¿ç”¨äº‹åŠ¡ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰
- âŒ å¿½ç•¥é”™è¯¯å¤„ç†

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–æ¸…å•

```
â–¡ ä½¿ç”¨æ‰¹é‡æ’å…¥ï¼ˆCreateInBatchesï¼‰
â–¡ æ‰¹æ¬¡å¤§å°è®¾ç½®ä¸º 100-500
â–¡ é…ç½®æ•°æ®åº“è¿æ¥æ± 
â–¡ æ·»åŠ å¿…è¦çš„ç´¢å¼•
â–¡ é¢„åˆ†é…åˆ‡ç‰‡å®¹é‡
â–¡ ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
â–¡ ç›‘æ§æ…¢æŸ¥è¯¢
â–¡ è¶…å¤§ç¾¤ä½¿ç”¨å¼‚æ­¥å¤„ç†
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

| æ‰¹æ¬¡å¤§å° | 1000æ¡è®°å½•è€—æ—¶ | å¹³å‡è€—æ—¶/æ¡ |
|---------|---------------|------------|
| 10      | ~10s          | 10ms       |
| 50      | ~2s           | 2ms        |
| **100** | **~380ms**    | **380Î¼s**  | â† æ¨è
| **200** | **~320ms**    | **320Î¼s**  | â† æ¨è
| 500     | ~280ms        | 280Î¼s      |
| 1000    | ~270ms        | 270Î¼s      |
| 2000    | ~320ms        | 320Î¼s      | â† è¾¹é™…æ”¶ç›Šé€’å‡

## ğŸ§ª å¦‚ä½•æµ‹è¯•

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
go test -bench=BenchmarkBatchInsert -benchmem ./internal/repo/

# è¿è¡Œå¯¹æ¯”æµ‹è¯•
go test -v -run=TestBatchSizeComparison ./internal/repo/

# è¿è¡Œæ€§èƒ½éªŒè¯
go test -v -run=TestBatchInsertPerformance ./internal/repo/
```

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸æ˜¯æ‰¹æ¬¡è¶Šå¤§è¶Šå¥½ï¼Ÿ

**A:** æ‰¹æ¬¡è¿‡å¤§ä¼šå¯¼è‡´ï¼š
- å†…å­˜å ç”¨å¢åŠ 
- å•ä¸ªäº‹åŠ¡æ—¶é—´è¿‡é•¿
- é”è¡¨æ—¶é—´å¢åŠ 
- è¾¹é™…æ”¶ç›Šé€’å‡

**æœ€ä¼˜åŒºé—´ï¼š100-500**

### Q2: å¦‚ä½•å¤„ç† 10000+ äººçš„è¶…å¤§ç¾¤ï¼Ÿ

**A:** ä½¿ç”¨å¼‚æ­¥åˆ†æ‰¹ç­–ç•¥ï¼š
```go
// 1. å…ˆåˆ›å»ºé¢‘é“å’Œå‰ 100 äººï¼ˆå¿«é€Ÿè¿”å›ï¼‰
CreateChannelWithMembers(channel, members[:100])

// 2. å¼‚æ­¥æ·»åŠ å‰©ä½™æˆå‘˜
go AddMembersAsync(channelID, members[100:], batchSize=500)
```

### Q3: PostgreSQL å’Œ MySQL çš„æ‰¹æ¬¡å¤§å°ä¸€æ ·å—ï¼Ÿ

**A:** ç•¥æœ‰ä¸åŒï¼š
- **PostgreSQL**: æ¨è 200-500ï¼ˆä¼˜åŒ–è¾ƒå¥½ï¼‰
- **MySQL**: æ¨è 100-300ï¼ˆå— max_allowed_packet é™åˆ¶ï¼‰

### Q4: å¦‚ä½•ç›‘æ§æ‰¹é‡æ’å…¥çš„æ€§èƒ½ï¼Ÿ

**A:** å…³é”®æŒ‡æ ‡ï¼š
```go
// 1. è®°å½•è€—æ—¶
duration := time.Since(start)

// 2. è®¡ç®—é€Ÿç‡
recordsPerSec := float64(count) / duration.Seconds()

// 3. ç›‘æ§æ…¢æŸ¥è¯¢
if duration > 200*time.Millisecond {
    logger.Warn("slow batch insert", zap.Duration("duration", duration))
}
```

### Q5: æ‰¹é‡æ’å…¥å¤±è´¥å¦‚ä½•å¤„ç†ï¼Ÿ

**A:** ä½¿ç”¨äº‹åŠ¡è‡ªåŠ¨å›æ»šï¼š
```go
return db.Transaction(func(tx *gorm.DB) error {
    if err := tx.Create(channel).Error; err != nil {
        return err // è‡ªåŠ¨å›æ»š
    }
    if err := tx.CreateInBatches(members, 200).Error; err != nil {
        return err // è‡ªåŠ¨å›æ»š
    }
    return nil // æäº¤
})
```

## ğŸ“ æœ€ä½³å®è·µæ€»ç»“

1. **é»˜è®¤ä½¿ç”¨æ‰¹æ¬¡ 200**ï¼Œè¦†ç›– 90% åœºæ™¯
2. **å°äº 100 äºº**ï¼šæ‰¹æ¬¡ 100ï¼Œä¸€æ¬¡æ€§æ’å…¥
3. **100-2000 äºº**ï¼šæ‰¹æ¬¡ 200ï¼Œæ€§èƒ½æœ€ä¼˜
4. **2000-5000 äºº**ï¼šæ‰¹æ¬¡ 500ï¼Œå¯æ¥å—å»¶è¿Ÿ
5. **è¶…è¿‡ 5000 äºº**ï¼šæ‰¹æ¬¡ 500 + å¼‚æ­¥åˆ†æ‰¹
6. **ç›‘æ§æ…¢æŸ¥è¯¢**ï¼šè¶…è¿‡ 200ms éœ€è¦ä¼˜åŒ–
7. **é…ç½®è¿æ¥æ± **ï¼šmax_open=50, max_idle=10
8. **é¢„åˆ†é…å†…å­˜**ï¼š`make([]*T, 0, capacity)`

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [å®Œæ•´æ€§èƒ½åˆ†ææ–‡æ¡£](./batch_insert_performance.md)
- [ç¾¤èŠåˆ›å»ºæ–¹æ¡ˆ](./channel_creation_solution.md)
- [ä»£ç ç¤ºä¾‹](../examples/channel_creation_example.go)
- [æ€§èƒ½æµ‹è¯•](../internal/repo/channel_repo_benchmark_test.go)

