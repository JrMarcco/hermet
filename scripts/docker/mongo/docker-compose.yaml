# MongoDB 分片集群配置
# 3 配置中心 + 3 分片集(每个1主2从) + TLS + 认证
x-mongo-common: &mongo-common
  image: mongo:latest
  restart: unless-stopped
  networks:
    - mongo-network

services:
  # ==================== 配置服务器副本集 ====================
  mongodb-config-server-1:
    <<: *mongo-common
    container_name: mongodb-config-server-1
    hostname: mongodb-config-server-1
    command: >
      mongod
      --configsvr
      --replSet configReplSet
      --port 27019
      --bind_ip_all
    volumes:
      - config-server-1-data:/data/db
      - config-server-1-config-data:/data/configdb

  mongodb-config-server-2:
    <<: *mongo-common
    container_name: mongodb-config-server-2
    hostname: mongodb-config-server-2
    command: >
      mongod
      --configsvr
      --replSet configReplSet
      --port 27019
      --bind_ip_all
    volumes:
      - config-server-2-data:/data/db
      - config-server-2-config-data:/data/configdb

  mongodb-config-server-3:
    <<: *mongo-common
    container_name: mongodb-config-server-3
    hostname: mongodb-config-server-3
    command: >
      mongod
      --configsvr
      --replSet configReplSet
      --port 27019
      --bind_ip_all
    volumes:
      - config-server-3-data:/data/db
      - config-server-3-config-data:/data/configdb

  # ==================== 分片1 副本集 (1主2从) ====================
  mongodb-shard1-primary:
    <<: *mongo-common
    container_name: mongodb-shard1-primary
    hostname: mongodb-shard1-primary
    command: >
      mongod
      --shardsvr
      --replSet shard1ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard1-primary-data:/data/db

  mongodb-shard1-secondary1:
    <<: *mongo-common
    container_name: mongodb-shard1-secondary1
    hostname: mongodb-shard1-secondary1
    command: >
      mongod
      --shardsvr
      --replSet shard1ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard1-secondary1-data:/data/db

  mongodb-shard1-secondary2:
    <<: *mongo-common
    container_name: mongodb-shard1-secondary2
    hostname: mongodb-shard1-secondary2
    command: >
      mongod
      --shardsvr
      --replSet shard1ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard1-secondary2-data:/data/db

  # ==================== 分片2 副本集 (1主2从) ====================
  mongodb-shard2-primary:
    <<: *mongo-common
    container_name: mongodb-shard2-primary
    hostname: mongodb-shard2-primary
    command: >
      mongod
      --shardsvr
      --replSet shard2ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard2-primary-data:/data/db

  mongodb-shard2-secondary1:
    <<: *mongo-common
    container_name: mongodb-shard2-secondary1
    hostname: mongodb-shard2-secondary1
    command: >
      mongod
      --shardsvr
      --replSet shard2ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard2-secondary1-data:/data/db

  mongodb-shard2-secondary2:
    <<: *mongo-common
    container_name: mongodb-shard2-secondary2
    hostname: mongodb-shard2-secondary2
    command: >
      mongod
      --shardsvr
      --replSet shard2ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard2-secondary2-data:/data/db

  # ==================== 分片3 副本集 (1主2从) ====================
  mongodb-shard3-primary:
    <<: *mongo-common
    container_name: mongodb-shard3-primary
    hostname: mongodb-shard3-primary
    command: >
      mongod
      --shardsvr
      --replSet shard3ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard3-primary-data:/data/db

  mongodb-shard3-secondary1:
    <<: *mongo-common
    container_name: mongodb-shard3-secondary1
    hostname: mongodb-shard3-secondary1
    command: >
      mongod
      --shardsvr
      --replSet shard3ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard3-secondary1-data:/data/db

  mongodb-shard3-secondary2:
    <<: *mongo-common
    container_name: mongodb-shard3-secondary2
    hostname: mongodb-shard3-secondary2
    command: >
      mongod
      --shardsvr
      --replSet shard3ReplSet
      --port 27018
      --bind_ip_all
    volumes:
      - shard3-secondary2-data:/data/db

  # ==================== Mongos 路由器 ====================
  mongodb-mongos:
    <<: *mongo-common
    container_name: mongodb-mongos
    hostname: mongodb-mongos
    command: >
      mongos
      --configdb configReplSet/mongodb-config-server-1:27019,mongodb-config-server-2:27019,mongodb-config-server-3:27019
      --port 27017
      --bind_ip_all
    ports:
      - "27017:27017"
    depends_on:
      - mongodb-config-server-1
      - mongodb-config-server-2
      - mongodb-config-server-3
      - mongodb-shard1-primary
      - mongodb-shard1-secondary1
      - mongodb-shard1-secondary2
      - mongodb-shard2-primary
      - mongodb-shard2-secondary1
      - mongodb-shard2-secondary2
      - mongodb-shard3-primary
      - mongodb-shard3-secondary1
      - mongodb-shard3-secondary2

networks:
  mongo-network:
    driver: bridge

volumes:
  config-server-1-data:
  config-server-1-config-data:
  config-server-2-data:
  config-server-2-config-data:
  config-server-3-data:
  config-server-3-config-data:
  shard1-primary-data:
  shard1-secondary1-data:
  shard1-secondary2-data:
  shard2-primary-data:
  shard2-secondary1-data:
  shard2-secondary2-data:
  shard3-primary-data:
  shard3-secondary1-data:
  shard3-secondary2-data:
