x-connect-common: &connect-common
  image: quay.io/debezium/connect:latest
  restart: unless-stopped
  networks:
    - jrmarcco_net
  environment: &connect-common-env
    # === Kafka Connect 基础配置 ===
    GROUP_ID: debezium-cluster
    CONFIG_STORAGE_TOPIC: debezium_configs
    OFFSET_STORAGE_TOPIC: debezium_offsets
    STATUS_STORAGE_TOPIC: debezium_statuses

    # 复制因子配置 ( 生产环境推荐 3 )
    CONFIG_STORAGE_REPLICATION_FACTOR: 3
    OFFSET_STORAGE_REPLICATION_FACTOR: 3
    STATUS_STORAGE_REPLICATION_FACTOR: 3

    # === Kafka 集群连接配置 ===
    BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}

    # === Kafka Connect 安全配置 (连接到 Kafka) ===
    CONNECT_SECURITY_PROTOCOL: SASL_SSL
    CONNECT_SASL_MECHANISM: OAUTHBEARER
    CONNECT_SASL_JAAS_CONFIG: org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required clientId="${DEBEZIUM_CLIENT_ID}" clientSecret="${DEBEZIUM_CLIENT_SECRET}";
    CONNECT_SASL_LOGIN_CALLBACK_HANDLER_CLASS: org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerLoginCallbackHandler
    CONNECT_SASL_OAUTHBEARER_TOKEN_ENDPOINT_URL: ${KC_URL}/realms/kafka/protocol/openid-connect/token

    # SSL 配置
    CONNECT_SSL_TRUSTSTORE_LOCATION: /etc/kafka/certs/kafka.client.truststore.jks
    CONNECT_SSL_TRUSTSTORE_PASSWORD: ${KAFKA_KEY_PASSWORD}
    CONNECT_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""

    # === Producer 配置 (Connect 向 Kafka 写入) ===
    CONNECT_PRODUCER_SECURITY_PROTOCOL: SASL_SSL
    CONNECT_PRODUCER_SASL_MECHANISM: OAUTHBEARER
    CONNECT_PRODUCER_SASL_JAAS_CONFIG: org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required clientId="${DEBEZIUM_CLIENT_ID}" clientSecret="${DEBEZIUM_CLIENT_SECRET}";
    CONNECT_PRODUCER_SASL_LOGIN_CALLBACK_HANDLER_CLASS: org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerLoginCallbackHandler
    CONNECT_PRODUCER_SASL_OAUTHBEARER_TOKEN_ENDPOINT_URL: ${KC_URL}/realms/kafka/protocol/openid-connect/token
    CONNECT_PRODUCER_SSL_TRUSTSTORE_LOCATION: /etc/kafka/certs/kafka.client.truststore.jks
    CONNECT_PRODUCER_SSL_TRUSTSTORE_PASSWORD: ${KAFKA_KEY_PASSWORD}
    CONNECT_PRODUCER_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""

    # Producer 性能配置
    CONNECT_PRODUCER_COMPRESSION_TYPE: snappy
    CONNECT_PRODUCER_ACKS: all
    CONNECT_PRODUCER_MAX_REQUEST_SIZE: 1048576
    CONNECT_PRODUCER_BATCH_SIZE: 16384
    CONNECT_PRODUCER_LINGER_MS: 10

    # === Consumer 配置 (Connect 从 Kafka 读取配置) ===
    CONNECT_CONSUMER_SECURITY_PROTOCOL: SASL_SSL
    CONNECT_CONSUMER_SASL_MECHANISM: OAUTHBEARER
    CONNECT_CONSUMER_SASL_JAAS_CONFIG: org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required clientId="${DEBEZIUM_CLIENT_ID}" clientSecret="${DEBEZIUM_CLIENT_SECRET}";
    CONNECT_CONSUMER_SASL_LOGIN_CALLBACK_HANDLER_CLASS: org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerLoginCallbackHandler
    CONNECT_CONSUMER_SASL_OAUTHBEARER_TOKEN_ENDPOINT_URL: ${KC_URL}/realms/kafka/protocol/openid-connect/token
    CONNECT_CONSUMER_SSL_TRUSTSTORE_LOCATION: /etc/kafka/certs/kafka.client.truststore.jks
    CONNECT_CONSUMER_SSL_TRUSTSTORE_PASSWORD: ${KAFKA_KEY_PASSWORD}
    CONNECT_CONSUMER_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""

    # === 转换器配置 ===
    CONNECT_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
    CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
    CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: false
    CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: false

    # === REST API 配置 ===
    CONNECT_REST_ADVERTISED_HOST_NAME: localhost
    CONNECT_REST_PORT: 8083

    # === 插件路径 ===
    CONNECT_PLUGIN_PATH: /kafka/connect,/kafka/libs

    # === 日志配置 ===
    CONNECT_LOG4J_ROOT_LOGLEVEL: INFO
    CONNECT_LOG4J_LOGGERS: org.apache.kafka.connect=INFO,io.debezium=INFO

    # === JVM 配置 ( 允许访问 Keycloak ) ===
    KAFKA_OPTS: -Dorg.apache.kafka.sasl.oauthbearer.allowed.urls=${KC_URL}/realms/kafka/protocol/openid-connect/certs,${KC_URL}/realms/kafka/protocol/openid-connect/token

    # === 任务配置 ===
    CONNECT_TASK_SHUTDOWN_GRACEFUL_TIMEOUT_MS: 30000
    CONNECT_OFFSET_FLUSH_INTERVAL_MS: 10000
    CONNECT_OFFSET_FLUSH_TIMEOUT_MS: 5000

  volumes:
    - ../kafka/certs:/etc/kafka/certs:ro
  healthcheck:
    test: ["CMD-SHELL", "curl -f http://localhost:8083/connectors || exit 1"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 60s

networks:
  jrmarcco_net:
    external: true

services:
  # === Debezium Connect 集群 ( 3 节点 ) ===
  debezium-connect-1:
    <<: *connect-common
    hostname: debezium-connect-1
    container_name: debezium-connect-1
    ports:
      - "18083:8083"
    environment:
      <<: *connect-common-env
      CONNECT_REST_ADVERTISED_HOST_NAME: debezium-connect-1

  debezium-connect-2:
    <<: *connect-common
    hostname: debezium-connect-2
    container_name: debezium-connect-2
    ports:
      - "28083:8083"
    environment:
      <<: *connect-common-env
      CONNECT_REST_ADVERTISED_HOST_NAME: debezium-connect-2

  debezium-connect-3:
    <<: *connect-common
    hostname: debezium-connect-3
    container_name: debezium-connect-3
    ports:
      - "38083:8083"
    environment:
      <<: *connect-common-env
      CONNECT_REST_ADVERTISED_HOST_NAME: debezium-connect-3

  # === Debezium UI ( 可选，用于管理和监控 ) ===
  debezium-ui:
    image: quay.io/debezium/debezium-ui:latest
    hostname: debezium-ui
    container_name: debezium-ui
    restart: unless-stopped
    ports:
      - "18082:8080"
    environment:
      KAFKA_CONNECT_URIS: http://debezium-connect-1:8083,http://debezium-connect-2:8083,http://debezium-connect-3:8083
    networks:
      - jrmarcco_net
    depends_on:
      debezium-connect-1:
        condition: service_healthy
      debezium-connect-2:
        condition: service_healthy
      debezium-connect-3:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
